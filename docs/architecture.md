# System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           家庭智能监控系统架构                                │
└─────────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────────────┐
                        │   Home Assistant    │
                        │  192.168.2.61:8123  │
                        │   (Docker on NAS)   │
                        └──────────┬──────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
   ┌──────────────────┐  ┌─────────────────┐  ┌──────────────────┐
   │  xiaomi_home 集成 │  │ generic camera  │  │  Lovelace 仪表盘  │
   │  (小米官方插件)   │  │  (HA 内置集成)  │  │  (单页房间布局)  │
   └────────┬─────────┘  └────────┬────────┘  └──────────────────┘
            │                     │
            │                     │ HTTP snapshot
            │                     │ http://<NAS_IP>:5000
            │                     │ /api/kid_room/latest.jpg
            │                     ▼
            │           ┌─────────────────────┐
            │           │     Frigate NVR      │
            │           │  <NAS_IP>:5000       │
            │           │   (Docker on NAS)    │
            └──────────►└──────────┬───────────┘
                                   │
                        ┌──────────┴────────────┐
                        │ RTSP pull (两路流)     │
                        │ :554/Channels/101(主流)│
                        │ :554/Channels/102(子流)│
                        └──────────┬────────────┘
                                   │
            ┌──────────────────────▼─────────────────────────────┐
            │         海康威视 DS-IPC-T12HV3-LA                   │
            │              <CAMERA_IP>:554                        │
            └──────────────────────┬─────────────────────────────┘
                                   │
                  ┌────────────────┴─────────────────┐
                  │                                  │
                  ▼                                  ▼
    ── 摄像头自带功能 ──                    ── Frigate 提供功能 ──
    ✦ 双码流 RTSP 推流                     ✦ 本地持续录像（60天）
    ✦ H.265 / H.264 编码                   ✦ 目标检测（人/猫/狗）
    ✦ 红外夜视                             ✦ 事件片段保存
    ✦ 宽动态 WDR                           ✦ 快照 API（latest.jpg）
    ✦ 音频录制                             ✦ Web UI（:5000）
    ✦ ISAPI HTTP 接口                      ✦ RTSP 转发（:8554）
    ✦ 摄像头本地 SD 卡录像                 ✦ WebRTC 推流（:8555）
    ✦ 网页管理界面                         ✦ CPU 对象检测（本地离线）
    ✦ 移动侦测（摄像头内置、不接入HA）      ✦ 录像存储到 NAS 磁盘

┌─────────────────────────────────────────────────────────────────────────────┐
│  小米智能摄像机 4 4K 2（独立设备，未接入 Frigate）                           │
│                                                                             │
│  ── 摄像头自带功能 ──          ── HA 中可控项（xiaomi_home）──               │
│  ✦ 4K 超高清                  ✦ 移动侦测 开/关（看家助手）switch 实体        │
│  ✦ AI 人形检测（云端）         ✦ 其他小米集成暴露的 switch/sensor             │
│  ✦ 夜视 / 声音检测                                                          │
│  ✦ 米家 App / 云端录像                                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  存储层：UGREEN NAS                                                         │
│  /volume1/homeRecording_KID_FIX/                                            │
│  ├── frigate-config/    ← Frigate 配置文件                                  │
│  └── recordings/        ← 视频录像文件（Frigate 写入，保留 60 天）           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Feature Ownership Summary

| Feature | Provider |
|---------|----------|
| 视频录像存到 NAS | **Frigate** |
| AI 目标检测（本地离线，人/猫/狗） | **Frigate** |
| 实时快照 API | **Frigate** |
| RTSP 双码流 | **海康威视摄像头自带** |
| 摄像头 SD 卡录像 | **海康威视摄像头自带** |
| 移动侦测开关（看家助手） | **小米摄像头自带** → xiaomi_home 集成暴露给 HA |
| Lovelace 仪表盘 | **Home Assistant** |
